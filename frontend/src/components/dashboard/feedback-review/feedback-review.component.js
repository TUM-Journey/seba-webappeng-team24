'use strict';

import FeedbackService from '../../../services/feedback/feedback.service';
import UserService from '../../../services/user/user.service';
import template from './feedback-review.template.html';
import './feedback-review.style.css';
import pdf from 'pdfjs'
import helvetica from './assets/Helvetica.json'
import helveticaBold from './assets/Helvetica-Bold.json'
import icon from './assets/evaluateone-icon.jpg'

class FeedbackReviewComponent {
  constructor() {
    this.controller = FeedbackReviewComponentController;
    this.template = template;

  }

  static get name() {
    return 'feedbackReview';
  }
}

class FeedbackReviewComponentController {

  constructor($scope, $state, feedbackService, userService, FileSaver, Blob) {
    this.FileSaver = FileSaver;
    this.Blob = Blob;
    this.$state = $state;
    this.feedbackService = feedbackService;
    this.userService = userService;

    this.users = userService.listAllUsers();

    this.selectedUser = null;
    this.feedbacks = null;
    this.avgMatrix = null;
    this.generation_date = new Date()
    this.title_date = this.generation_date.toLocaleDateString()
    this.generation_date = this.generation_date.toLocaleString()
  }

  refreshFeedbacks() {
    if (!this.selectedUser) {
      this.feedbacks = [];
      return;
    }

    this.feedbacks = this.feedbackService.listAll({ username: this.selectedUser.username });
    for (let feedback of this.feedbacks) {
      var d = new Date(feedback.created_at)
      feedback.created_at = d.toLocaleString()
    }
  }

  save(doc) {
    return doc.asBuffer()
      .then(buf => {
        const blob = new this.Blob([buf], { type: 'application/pdf' })
        console.log(this.feedbacks)
        let pdfName = this.feedbacks[0].user.name + "_" + this.title_date + '.pdf'
        return this.FileSaver.saveAs(blob, pdfName)

      })
  }

  generatePdf() {

    const doc = new pdf.Document({
      font: new pdf.Font(helvetica),
      padding: 10
    })

    // Trying to load this fucking image into a buffer so that I can use it as an argument
    // in new pdf.Image(buffer)
    var header = doc.header().table({ widths: [null, null], paddingBottom: 2 * pdf.cm }).row()
    var buffer = fetch(icon)
      .then((response) => {
        return response.blob()
      })
      .then((blob) => {
        var fr = new FileReader()
        var buffer = fr.readAsArrayBuffer(blob)
        console.log(buffer)
      })
    // header.cell().image(new pdf.Image(buffer), { height: 2 * pdf.cm })
    header.cell().text("Evaluati.one", { fontSize: 16, color: '#ff0000' })
    header.cell().text({ textAlign: 'right' })
      .add('Generated at: ' + this.generation_date).br()
      .add('This document is generated by the evaluati.one app, made by the Seba-24 group')
      .add('https://github.com/wingsofovnia/seba-webappeng-team24', {
        link: 'https://github.com/wingsofovnia/seba-webappeng-team24',
        underline: true,
        color: 0x569cd6
      })

    doc.footer()
      .pageNumber((curr, total) => `${curr} / ${total}`, { textAlign: 'center', fontSize: 16 })

    doc.text("Feedback Report of " + this.feedbacks[0].user.name, {
      fontSize: 16, font: new pdf.Font(helveticaBold)
      , color: "#ff0000", textAlign: 'center'
    }).br()

    console.log(this.avgMatrix)
    doc.text("Averages", { textAlign: 'center', fontSize: 14 }).br()
    let table = doc.table({
      widths: [null, null],
      borderWidth: 3,
      padding: 5,
    })
    // fix this
    for (let competency of this.feedbacks[0].competencies) {
      let tr = table.row()
      tr.cell(competency.characteristic.name, { textAlign: 'center' })
      tr.cell(this.avgMatrix[competency.characteristic.name], { textAlign: 'center' })
      // doc.text(competency.characteristic.name + ":" + this.avgMatrix[competency.characteristic.name])
    }

    for (var i = 0; i < this.feedbacks.length; i++) {
      let feedback = this.feedbacks[i]
      // console.log(feedback)
      doc.text('  #' + i)
      doc.text('  Author: ' + feedback.author.name, { fontSize: 12, color: "#00008b" })
      doc.text('  Summary: ' + feedback.summary)
      let d = new Date(feedback.created_at)
      doc.text('  Submitted at: ' + d.toLocaleString()).br()
      let table = doc.table({
        widths: [null, null],
        borderWidth: 3,
        padding: 10,
      })
      for (let competency of feedback.competencies) {
        let tr = table.row()
        tr.cell(competency.characteristic.name, { textAlign: 'center' })
        tr.cell(competency.grade + "/10", { textAlign: 'center' })
      }
    }
    const file = this.save(doc)
    console.log(file)

  }


  refreshAvgMatrix() {
    if (!this.selectedUser) {
      this.avgMatrix = null;
      return;
    }

    this.avgMatrix = this.feedbackService.userAvgMatrix({ username: this.selectedUser.username });
  }

  static get $inject() {
    return ['$scope', '$state', FeedbackService.name, UserService.name, 'FileSaver', 'Blob'];
  }
}


export default FeedbackReviewComponent;
